version: "3"

tasks:
  all:
    desc: Build for distribution for all platforms
    cmds:
      - task: Windows_32bit
      - task: Windows_64bit
      - task: Linux_32bit
      - task: Linux_64bit
      - task: Linux_ARMv6
      - task: Linux_ARMv7
      - task: Linux_ARM64
      - task: macOS_64bit

  Windows_32bit:
    desc: Builds Windows 32 bit binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        zip {{ .PACKAGE_NAME}} {{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }}.exe ../LICENSE.txt -j
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_windows_386"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }}.exe {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "windows/386"
      CONTAINER_TAG: "{{ .GO_VERSION }}-main"
      PACKAGE_PLATFORM: "Windows_32bit"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.zip"

  Windows_64bit:
    desc: Builds Windows 64 bit binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        zip {{ .PACKAGE_NAME}} {{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }}.exe ../LICENSE.txt -j
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_windows_amd64"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }}.exe {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "windows/amd64"
      CONTAINER_TAG: "{{ .GO_VERSION }}-main"
      PACKAGE_PLATFORM: "Windows_64bit"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.zip"

  Linux_32bit:
    desc: Builds Linux 32 bit binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        tar cz -C {{ .PLATFORM_DIR }} {{ .PROJECT_NAME }} -C ../.. LICENSE.txt  -f {{ .PACKAGE_NAME }}
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_linux_amd32"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }} {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "linux/386"
      CONTAINER_TAG: "{{ .GO_VERSION }}-main"
      PACKAGE_PLATFORM: "Linux_32bit"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.tar.gz"

  Linux_64bit:
    desc: Builds Linux 64 bit binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        tar cz -C {{ .PLATFORM_DIR }} {{ .PROJECT_NAME }} -C ../.. LICENSE.txt  -f {{ .PACKAGE_NAME }}
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_linux_amd64"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }} {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "linux/amd64"
      CONTAINER_TAG: "{{ .GO_VERSION }}-main"
      PACKAGE_PLATFORM: "Linux_64bit"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.tar.gz"

  Linux_ARMv7:
    desc: Builds Linux ARMv7 binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        tar cz -C {{ .PLATFORM_DIR }} {{ .PROJECT_NAME }} -C ../.. LICENSE.txt  -f {{ .PACKAGE_NAME }}
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_linux_arm_7"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }} {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "linux/armv7"
      CONTAINER_TAG: "{{ .GO_VERSION }}-arm"
      PACKAGE_PLATFORM: "Linux_ARMv7"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.tar.gz"

  Linux_ARMv6:
    desc: Builds Linux ARMv6 binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        tar cz -C {{ .PLATFORM_DIR }} {{ .PROJECT_NAME }} -C ../.. LICENSE.txt  -f {{ .PACKAGE_NAME }}
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_linux_arm_6"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }} {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "linux/armv6"
      CONTAINER_TAG: "{{ .GO_VERSION }}-arm"
      PACKAGE_PLATFORM: "Linux_ARMv6"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.tar.gz"

  Linux_ARM64:
    desc: Builds Linux ARM64 binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        tar cz -C {{ .PLATFORM_DIR }} {{ .PROJECT_NAME }} -C ../.. LICENSE.txt  -f {{ .PACKAGE_NAME }}
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_linux_arm_6"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }} {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "linux/arm64"
      CONTAINER_TAG: "{{ .GO_VERSION }}-arm"
      PACKAGE_PLATFORM: "Linux_ARM64"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.tar.gz"

  macOS_64bit:
    desc: Builds Mac OS X 64 bit binaries
    dir: "{{ .DIST_DIR }}"
    cmds:
      - |
        docker run -v `pwd`/..:/home/lint -w /home/lint \
        -e CGO_ENABLED=1 \
        {{ .CONTAINER }}:{{ .CONTAINER_TAG }} \
        --build-cmd "{{ .BUILD_COMMAND }}" \
        -p "{{ .BUILD_PLATFORM }}"

        tar cz -C {{ .PLATFORM_DIR }} {{ .PROJECT_NAME }} -C ../.. LICENSE.txt  -f {{ .PACKAGE_NAME }}
        sha256sum {{ .PACKAGE_NAME }} >> {{ .CHECKSUM_FILE }}

    vars:
      PLATFORM_DIR: "{{ .PROJECT_NAME }}_osx_darwin_amd64"
      BUILD_COMMAND: "go build -o {{ .DIST_DIR }}/{{ .PLATFORM_DIR }}/{{ .PROJECT_NAME }} {{ .DIST_LDFLAGS }}"
      BUILD_PLATFORM: "darwin/amd64"
      CONTAINER_TAG: "{{ .GO_VERSION }}-darwin"
      PACKAGE_PLATFORM: "macOS_64bit"
      PACKAGE_NAME: "{{ .PROJECT_NAME }}-{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}_{{ .PACKAGE_PLATFORM }}.tar.gz"

vars:
  VERSION:
    sh: echo "`git describe --tags --abbrev=0`"
  TIMESTAMP_SHORT:
    sh: echo "{{now | date "20060102"}}"
  DIST_LDFLAGS: >-
    -ldflags
    '
    -X {{ .CONFIGURATION_PACKAGE }}.version={{.VERSION}}
    -X {{ .CONFIGURATION_PACKAGE }}.commit={{.COMMIT}}
    -X {{ .CONFIGURATION_PACKAGE }}.buildTimestamp={{.TIMESTAMP}}
    '
  CONTAINER: "docker.elastic.co/beats-dev/golang-crossbuild"
  GO_VERSION: "1.14.7"
  CHECKSUM_FILE: "{{ .VERSION }}-{{ .TIMESTAMP_SHORT }}-checksums.txt"
